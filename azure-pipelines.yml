trigger:
- master

stages:

# =========================
# Stage 1: Build Demo Backend Only
# =========================
- stage: Build
  displayName: 'Build Demo Backend Module'
  jobs:
  - job: BuildJob
    displayName: 'Build Demo Backend Only'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    # Build only the demo-backend module and skip reactor errors for other modules
    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        options: '-pl demo-backend -am -fn'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'

    - script: |
        echo "Listing target folder of demo-backend:"
        ls -lh demo-backend/target
      displayName: 'Debug: List demo-backend artifact'

    # Publish the demo-backend WAR
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.SourcesDirectory)/demo-backend/target'
        artifactName: 'demo-backend'

# =========================
# Stage 2: Deploy
# =========================
- stage: Deploy
  displayName: 'Deploy Demo Backend'
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: 'Deploy to Remote Server'
    pool:
      name: 'Java_Deployment'  # replace with your self-hosted agent if needed
    steps:
    # Download the artifact
    - download: current
      artifact: 'demo-backend'

    # Copy WAR to remote server
    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'Java_YAML'
        sourceFolder: '$(Pipeline.Workspace)/demo-backend'
        contents: '*.war'
        targetFolder: '/home/itadmin/javaapp'

    # Kill old process on custom port, run WAR with nohup & logging
    - task: SSH@0
      inputs:
        sshEndpoint: 'Java_YAML'
        runOptions: 'commands'
        commands: |
          set -e
          PORT=8090   # change to desired port

          echo "Stopping any process on port $PORT..."
          fuser -k $PORT/tcp || echo "No process running on port $PORT"

          echo "Starting demo backend on port $PORT..."
          nohup java -jar /home/itadmin/javaapp/demo-backend-*.war \
            --server.port=$PORT \
            --spring.config.location=file:/home/itadmin/javaapp/application.properties \
            > /home/itadmin/javaapp/app.log 2>&1 &
          disown
          echo "Demo backend started successfully"
      timeoutInMinutes: 10
