trigger:
- master

variables:
  DEMO_PORT: 8090           # Change this to your desired port
  REMOTE_DIR: /home/itadmin/javaapp
  SSH_ENDPOINT: Java_YAML
  MODULE_NAME: demo

stages:

# =========================
# Stage 1: Build Demo Module
# =========================
- stage: Build
  displayName: 'Build Demo Module'
  jobs:
  - job: BuildJob
    displayName: 'Build Demo Only'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    # Build only the demo module and skip other errors
    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        options: '-pl $(MODULE_NAME) -am -fn'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'

    # Debug: List target folder
    - script: |
        echo "Listing files in $(MODULE_NAME)/target:"
        ls -lh "$(MODULE_NAME)/target" || echo "No files found in target"
      displayName: 'Debug: List demo artifact'

    # Publish the demo WAR
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: "$(Build.SourcesDirectory)/$(MODULE_NAME)/target"
        artifactName: 'demo'

# =========================
# Stage 2: Deploy
# =========================
- stage: Deploy
  displayName: 'Deploy Demo Module'
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: 'Deploy to Remote Server'
    pool:
      name: 'Java_Deployment'  # replace with your self-hosted agent if needed
    steps:
    # Download the artifact
    - download: current
      artifact: 'demo'

    # Debug: List downloaded files
    - script: |
        echo "Listing downloaded artifact contents:"
        ls -lh "$(Pipeline.Workspace)/demo" || echo "No files downloaded"
      displayName: 'Debug: List downloaded artifact'

    # Copy WAR to remote server
    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: "$(SSH_ENDPOINT)"
        sourceFolder: "$(Pipeline.Workspace)/demo"
        contents: '*.war'
        targetFolder: "$(REMOTE_DIR)"

    # Kill old process on custom port, run WAR with nohup & logging
    - task: SSH@0
      inputs:
        sshEndpoint: "$(SSH_ENDPOINT)"
        runOptions: 'commands'
        commands: |
          set -e
          echo "Stopping any process on port $(DEMO_PORT)..."
          fuser -k "$(DEMO_PORT)/tcp" || echo "No process running on port $(DEMO_PORT)"

          echo "Starting demo module on port $(DEMO_PORT)..."
          nohup java -jar "$(REMOTE_DIR)/$(MODULE_NAME)-*.war" \
            --server.port=$(DEMO_PORT) \
            --spring.config.location=file:"$(REMOTE_DIR)/application.properties" \
            > "$(REMOTE_DIR)/app.log" 2>&1 &
          disown
          echo "Demo module started successfully"

